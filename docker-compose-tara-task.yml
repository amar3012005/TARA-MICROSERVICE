# TARA X TASK - Complete Microservices Stack
# All services organized in dedicated Docker Desktop network
# Project name: tara-task (appears as folder in Docker Desktop)

name: tara-task

services:
  # ============================================================================
  # Foundation: Redis
  # ============================================================================
  redis:
    image: redis:7-alpine
    container_name: tara-task-redis
    ports:
      - "2006:6379"
    volumes:
      - tara_task_redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s
    networks:
      - tara-task-network
    restart: unless-stopped
    labels:
      - "com.tara.project=tara-task"
      - "com.tara.service=redis"

  # ============================================================================
  # Master Controller: Orchestrator
  # ============================================================================
  orchestrator:
    build:
      context: .
      dockerfile: orchestrator/Dockerfile
    container_name: tara-task-orchestrator
    ports:
      - "2004:8004"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./docker-compose-tara-task.yml:/app/docker-compose-tara-task.yml:ro
    environment:
      - PYTHONUNBUFFERED=1
      - REDIS_URL=redis://tara-task-redis:6379/0
      - LEIBNIZ_REDIS_HOST=tara-task-redis
      - LEIBNIZ_REDIS_PORT=6379
      - LEIBNIZ_REDIS_DB=0
      - INTENT_SERVICE_URL=http://localhost:8002
      - RAG_SERVICE_URL=http://tara-task-rag:8003
      # STT Service Selection: stt-vad (Gemini) or stt-sarvam (Sarvam Streaming)
      # Set USE_SARVAM_STT=true to use Sarvam STT, false for Gemini STT
      - USE_SARVAM_STT=${USE_SARVAM_STT:-false}
      # Default STT URL (can be overridden by STT_SERVICE_URL env var)
      - STT_SERVICE_URL=${STT_SERVICE_URL:-http://tara-task-stt-vad:8001}
      # Individual STT service URLs for orchestrator selection
      - STT_SARVAM_URL=http://tara-task-stt-sarvam:8001
      - STT_VAD_URL=http://tara-task-stt-vad:8001
      - TTS_SERVICE_URL=${TTS_SERVICE_URL:-http://tara-task-tts-sarvam:8025}
      - TTS_STREAMING_MODE=${TTS_STREAMING_MODE:-continuous}
      # ElevenLabs TTS Direct Streaming Configuration
      - USE_ELEVENLABS_TTS=${USE_ELEVENLABS_TTS:-true}
      - ELEVENLABS_TTS_URL=${ELEVENLABS_TTS_URL:-http://tara-task-tts-labs:8006}
      - ELEVENLABS_PREWARM_ON_VAD=${ELEVENLABS_PREWARM_ON_VAD:-true}
      - TARA_MODE=true
      - SKIP_INTENT_SERVICE=true
      - SKIP_APPOINTMENT_SERVICE=true
      - RESPONSE_LANGUAGE=te-mixed
      - ORGANIZATION_NAME=TASK
      - IGNORE_STT_WHILE_SPEAKING=true
      - INTRO_GREETING=నమస్కారం అండి! నేను TARA, TASK యొక్క కస్టమర్ సర్వీస్ ఏజెంట్. మీకు ఎలా సహాయం చేయగలను?
      - AUTO_START_SERVICES=false
      - DOCKER_COMPOSE_FILE=/app/docker-compose-tara-task.yml
      - DOCKER_PROJECT_NAME=tara-task
      - DOCKER_CONTEXT=desktop-linux
      - STT_GRADIO_URL=http://localhost:2012
      - TTS_GRADIO_URL=http://localhost:2007/fastrtc  # tts-labs FastRTC (port 2007)
      - LOG_LEVEL=INFO
      - SESSION_TTL_SECONDS=3600
      - MAX_CONCURRENT_SESSIONS=1000
      - PORT=8004
      - ORCHESTRATOR_PORT=2004  # External port for unified FastRTC URL
      - LIVEKIT_API_KEY=${LIVEKIT_API_KEY:-devkey}
      - LIVEKIT_API_SECRET=${LIVEKIT_API_SECRET:-secret}
      - LIVEKIT_URL=http://livekit:7880
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - tara-task-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8004/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 3
    labels:
      - "com.tara.project=tara-task"
      - "com.tara.service=orchestrator"
      - "com.tara.role=master-controller"

  # ============================================================================
  # Speech-to-Text: STT-VAD Service
  # ============================================================================
  stt-vad:
    build:
      context: .
      dockerfile: stt_vad/Dockerfile
    container_name: tara-task-stt-vad
    ports:
      - "2001:8001"   # API
      - "2012:8001"   # FastRTC (mapped to API port)
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - PYTHONUNBUFFERED=1
      - STT_VAD_HOST=0.0.0.0
      - STT_VAD_PORT=8001
      - FAST_RTC_PORT=7860
      - REDIS_HOST=tara-task-redis
      - REDIS_PORT=6379
      - LEIBNIZ_REDIS_HOST=tara-task-redis
      - LEIBNIZ_REDIS_PORT=6379
      - LEIBNIZ_REDIS_DB=0
      - DOCKER_ENVIRONMENT=true
      - GEMINI_API_KEY=${GEMINI_API_KEY:-AIzaSyAebmHUweveB2h7jUkJdOeZAyHHLIq3Y7E}
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - tara-task-network
    restart: unless-stopped
    stdin_open: true
    tty: true
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8001/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 3
    labels:
      - "com.tara.project=tara-task"
      - "com.tara.service=stt-vad"

  # ============================================================================
  # Speech-to-Text: STT Sarvam Service (Sarvam AI Streaming STT)
  # Ultra-low latency streaming STT with partial transcript support for RAG
  # ============================================================================
  stt-sarvam:
    build:
      context: .
      dockerfile: stt_sarvam/Dockerfile
    container_name: tara-task-stt-sarvam
    ports:
      - "2002:8001"   # API + WebSocket
      - "2013:8001"   # FastRTC UI (mapped to API port)
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      # Python configuration
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      
      # Service configuration
      - STT_VAD_HOST=0.0.0.0
      - STT_VAD_PORT=8001
      - FAST_RTC_PORT=7860
      - DOCKER_ENVIRONMENT=true
      
      # Redis configuration
      - REDIS_HOST=tara-task-redis
      - REDIS_PORT=6379
      - LEIBNIZ_REDIS_HOST=tara-task-redis
      - LEIBNIZ_REDIS_PORT=6379
      - LEIBNIZ_REDIS_DB=0
      
      # Sarvam API Configuration
      # Note: Code expects SARVAM_API_SUBSCRIPTION_KEY (not SARVAM_API_KEY)
      - SARVAM_API_SUBSCRIPTION_KEY=${SARVAM_API_SUBSCRIPTION_KEY:-sk_2d8w6udi_gaPItmPcCEsf3CoON7RBzqPr}
      - SARVAM_API_ENDPOINT=${SARVAM_API_ENDPOINT:-}
      
      # Sarvam Streaming STT Configuration
      - LEIBNIZ_VAD_MODEL=${LEIBNIZ_VAD_MODEL:-saarika:v2.5}
      - LEIBNIZ_VAD_LANGUAGE=${LEIBNIZ_VAD_LANGUAGE:-unknown}
      - LEIBNIZ_VAD_ENABLE_LANGUAGE_DETECTION=${LEIBNIZ_VAD_ENABLE_LANGUAGE_DETECTION:-true}
      - LEIBNIZ_VAD_SAMPLE_RATE=${LEIBNIZ_VAD_SAMPLE_RATE:-16000}
      - LEIBNIZ_VAD_CHANNELS=${LEIBNIZ_VAD_CHANNELS:-1}
      
      # Sarvam Streaming Parameters (Ultra-low latency)
      - SARVAM_HIGH_VAD_SENSITIVITY=${SARVAM_HIGH_VAD_SENSITIVITY:-true}
      - SARVAM_VAD_SIGNALS=${SARVAM_VAD_SIGNALS:-true}
      
      # Timeout configuration
      - LEIBNIZ_VAD_TIMEOUT_INITIAL=${LEIBNIZ_VAD_TIMEOUT_INITIAL:-20.0}
      - LEIBNIZ_VAD_TIMEOUT_RETRY=${LEIBNIZ_VAD_TIMEOUT_RETRY:-10.0}
      - LEIBNIZ_VAD_TIMEOUT_MAX=${LEIBNIZ_VAD_TIMEOUT_MAX:-30.0}
      - LEIBNIZ_VAD_TIMEOUT_START=${LEIBNIZ_VAD_TIMEOUT_START:-20.0}
      
      # Granular timeout configuration
      - LEIBNIZ_VAD_TIMEOUT_GREETING=${LEIBNIZ_VAD_TIMEOUT_GREETING:-25.0}
      - LEIBNIZ_VAD_TIMEOUT_DECISION=${LEIBNIZ_VAD_TIMEOUT_DECISION:-30.0}
      - LEIBNIZ_VAD_TIMEOUT_COMPLEX=${LEIBNIZ_VAD_TIMEOUT_COMPLEX:-35.0}
      - LEIBNIZ_VAD_TIMEOUT_POST_SERVICE=${LEIBNIZ_VAD_TIMEOUT_POST_SERVICE:-20.0}
      
      # VAD and silence detection (legacy, mostly unused with server-side VAD)
      - LEIBNIZ_VAD_SILENCE_TIMEOUT=${LEIBNIZ_VAD_SILENCE_TIMEOUT:-1.5}
      - LEIBNIZ_VAD_MIN_SPEECH_MS=${LEIBNIZ_VAD_MIN_SPEECH_MS:-350}
      - LEIBNIZ_VAD_MAX_BUFFER_MS=${LEIBNIZ_VAD_MAX_BUFFER_MS:-6000}
      - LEIBNIZ_VAD_PARTIAL_FLUSH_MS=${LEIBNIZ_VAD_PARTIAL_FLUSH_MS:-3500}
      
      # Session management
      - LEIBNIZ_VAD_SESSION_TIMEOUT=${LEIBNIZ_VAD_SESSION_TIMEOUT:-600.0}
      - LEIBNIZ_VAD_MAX_SESSION_DURATION=${LEIBNIZ_VAD_MAX_SESSION_DURATION:-600.0}
      
      # Logging configuration
      - LEIBNIZ_VAD_VERBOSE=${LEIBNIZ_VAD_VERBOSE:-false}
      - LEIBNIZ_VAD_LOG_AUDIO_CALLBACKS=${LEIBNIZ_VAD_LOG_AUDIO_CALLBACKS:-false}
      - LEIBNIZ_VAD_LOG_TIMEOUT_CHECKS=${LEIBNIZ_VAD_LOG_TIMEOUT_CHECKS:-false}
      - LEIBNIZ_VAD_LOG_STATE_TRANSITIONS=${LEIBNIZ_VAD_LOG_STATE_TRANSITIONS:-true}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      
      # Response settings
      - LEIBNIZ_VAD_RESPONSE_MODALITY=${LEIBNIZ_VAD_RESPONSE_MODALITY:-TEXT}
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - tara-task-network
    restart: unless-stopped
    stdin_open: true
    tty: true
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8001/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      start_period: 40s
      retries: 3
    labels:
      - "com.tara.project=tara-task"
      - "com.tara.service=stt-sarvam"
      - "com.tara.role=speech-to-text"
      - "com.tara.provider=sarvam"
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "2"

  # ============================================================================
  # RAG: Knowledge Base Service
  # ============================================================================
  rag:
    build:
      context: .
      dockerfile: rag/Dockerfile.tara
    container_name: tara-task-rag
    ports:
      - "2003:8003"
    volumes:
      - tara_task_rag_index_v2:/app/index
    environment:
      - PYTHONUNBUFFERED=1
      - GEMINI_API_KEY=${GEMINI_API_KEY:-AIzaSyAebmHUweveB2h7jUkJdOeZAyHHLIq3Y7E}
      - GEMINI_MODEL=gemini-2.0-flash-lite
      - LEIBNIZ_REDIS_HOST=tara-task-redis
      - LEIBNIZ_REDIS_PORT=6379
      - LEIBNIZ_REDIS_DB=0
      - LEIBNIZ_RAG_KNOWLEDGE_BASE_PATH=/app/leibniz_knowledge_base
      - LEIBNIZ_RAG_VECTOR_STORE_PATH=/app/index
      - TARA_MODE=true
      - LEIBNIZ_RAG_RESPONSE_LANGUAGE=te-mixed
      - LEIBNIZ_RAG_ORGANIZATION=TASK
      - LEIBNIZ_RAG_AGENT_NAME=TARA
      - PORT=8003
      - LOG_LEVEL=INFO
      - ENABLE_PREWARMING=true
      - WARMUP_QUERIES_COUNT=10
      - ENABLE_MODEL_PERSISTENCE=true
      - PREPOPULATE_CACHE=false
      - GEMINI_TIMEOUT_MS=5000
      - EMBEDDING_BATCH_SIZE=32
      # Embedding optimization (new)
      - LEIBNIZ_RAG_EMBEDDING_MODEL=BAAI/bge-m3
      - ENABLE_EMBEDDING_CACHE=true
      - EMBEDDING_CACHE_TTL=86400
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - tara-task-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8003/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 3
    labels:
      - "com.tara.project=tara-task"
      - "com.tara.service=rag"

  # ============================================================================
  # Text-to-Speech: TTS Sarvam Service
  # ============================================================================
  tts-sarvam:
    build:
      context: .
      dockerfile: tts_sarvam/Dockerfile
    container_name: tara-task-tts-sarvam
    ports:
      - "2005:8025"   # API + FastRTC
    environment:
      - PYTHONUNBUFFERED=1
      - SARVAM_API_KEY=${SARVAM_API_KEY:-sk_2d8w6udi_gaPItmPcCEsf3CoON7RBzqPr}
      - LEIBNIZ_SARVAM_SPEAKER=anushka
      - LEIBNIZ_SARVAM_LANGUAGE=te-IN
      - LEIBNIZ_SARVAM_MODEL=bulbul:v2
      - TTS_STREAMING_PORT=8025
      - LEIBNIZ_TTS_CACHE_ENABLED=true
      - LEIBNIZ_TTS_SAMPLE_RATE=22050
      - REDIS_HOST=tara-task-redis
      - REDIS_PORT=6379
      - LEIBNIZ_REDIS_HOST=tara-task-redis
      - LEIBNIZ_REDIS_PORT=6379
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - tara-task-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8025/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 3
    labels:
      - "com.tara.project=tara-task"
      - "com.tara.service=tts-sarvam"
# =========================================================================
  # ============================================================================
  # TTS_LABS: ElevenLabs Ultra-Low Latency TTS Service
  # Uses eleven_turbo_v2_5 model with WebSocket stream-input for <150ms TTFA
  # =========================================================================
  tts-labs:
    build:
      context: .
      dockerfile: TTS_LABS/Dockerfile
    container_name: tara-task-tts-labs
    ports:
      - "2007:8006"   # API + FastRTC (different port from tts-sarvam:2005)
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - PYTHONUNBUFFERED=1
      # ElevenLabs API Configuration
      - ELEVENLABS_API_KEY=${ELEVENLABS_API_KEY:-sk_b52c643178d624ed09d8b52da3554ee7ff3096d02e55299b}
      - ELEVENLABS_VOICE_ID=${ELEVENLABS_VOICE_ID:-AnvlJBAqSLDzEevYr9Ap}
      - ELEVENLABS_MODEL_ID=${ELEVENLABS_MODEL_ID:-eleven_turbo_v2_5}
      - ELEVENLABS_LATENCY_OPTIMIZATION=${ELEVENLABS_LATENCY_OPTIMIZATION:-4}
      - ELEVENLABS_OUTPUT_FORMAT=${ELEVENLABS_OUTPUT_FORMAT:-pcm_24000}
      # Voice settings
      - ELEVENLABS_STABILITY=${ELEVENLABS_STABILITY:-0.5}
      - ELEVENLABS_SIMILARITY_BOOST=${ELEVENLABS_SIMILARITY_BOOST:-0.75}
      - ELEVENLABS_STYLE=${ELEVENLABS_STYLE:-0.0}
      - ELEVENLABS_SPEAKER_BOOST=${ELEVENLABS_SPEAKER_BOOST:-true}
      # Service configuration
      - TTS_LABS_PORT=8006
      - LEIBNIZ_TTS_CACHE_DIR=/app/audio_cache
      - LEIBNIZ_TTS_CACHE_ENABLED=true
      - LEIBNIZ_TTS_CACHE_MAX_SIZE=500
      - LEIBNIZ_TTS_INTER_SENTENCE_GAP_MS=50
      - LEIBNIZ_TTS_FASTRTC_CHUNK_MS=40
      # Redis for orchestrator coordination (matches tara-task Redis on port 6379)
      - REDIS_HOST=tara-task-redis
      - REDIS_PORT=6379
      - LEIBNIZ_REDIS_HOST=tara-task-redis
      - LEIBNIZ_REDIS_PORT=6379
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - tara-task-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8006/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 3
    labels:
      - "com.tara.project=tara-task"
      - "com.tara.service=tts-labs"
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "2"

  # ============================================================================
  # LiveKit: WebRTC Server
  # ============================================================================
  livekit:
    image: livekit/livekit-server
    container_name: tara-task-livekit
    command: --dev --bind 0.0.0.0
    ports:
      - "7880:7880"
      - "7881:7881"
      - "7882:7882/udp"
    networks:
      - tara-task-network
    restart: unless-stopped
    labels:
      - "com.tara.project=tara-task"
      - "com.tara.service=livekit"

  # ============================================================================
  # LiveKit Bridge: Connection Agent
  # ============================================================================
  livekit-bridge:
    build:
      context: .
      dockerfile: livekit_bridge/Dockerfile
    container_name: tara-task-livekit-bridge
    environment:
      - LIVEKIT_URL=ws://livekit:7880
      - LIVEKIT_API_KEY=${LIVEKIT_API_KEY:-devkey}
      - LIVEKIT_API_SECRET=${LIVEKIT_API_SECRET:-secret}
      - STT_URL=ws://tara-task-stt-vad:8001/api/v1/transcribe/stream
      - ORCHESTRATOR_URL=ws://tara-task-orchestrator:8004/orchestrate
    depends_on:
      - livekit
      - stt-vad
      - orchestrator
    networks:
      - tara-task-network
    restart: unless-stopped
    labels:
      - "com.tara.project=tara-task"
      - "com.tara.service=livekit-bridge"

# ============================================================================
# Volumes
# ============================================================================
volumes:
  tara_task_redis_data:
    name: tara-task-redis-data
    labels:
      - "com.tara.project=tara-task"
  tara_task_rag_index_v2:
    name: tara-task-rag-index-v2
    labels:
      - "com.tara.project=tara-task"

# ============================================================================
# Network
# ============================================================================
networks:
  tara-task-network:
    name: tara-task-network
    driver: bridge
    labels:
      - "com.tara.project=tara-task"


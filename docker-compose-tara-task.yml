# TARA X TASK - Complete Microservices Stack
# All services organized in dedicated Docker Desktop network
# Project name: tara-task (appears as folder in Docker Desktop)

name: tara-task

services:
  # ============================================================================
  # Foundation: Redis
  # ============================================================================
  redis:
    image: redis:7-alpine
    container_name: tara-task-redis
    ports:
      - "2006:6379"
    volumes:
      - tara_task_redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s
    networks:
      - tara-task-network
    restart: unless-stopped
    labels:
      - "com.tara.project=tara-task"
      - "com.tara.service=redis"

  # ============================================================================
  # Master Controller: Orchestrator
  # ============================================================================
  orchestrator:
    build:
      context: .
      dockerfile: orchestrator/Dockerfile
    container_name: tara-task-orchestrator
    ports:
      - "2004:8004"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./docker-compose-tara-task.yml:/app/docker-compose-tara-task.yml:ro
    environment:
      - PYTHONUNBUFFERED=1
      - REDIS_URL=redis://tara-task-redis:6379/0
      - LEIBNIZ_REDIS_HOST=tara-task-redis
      - LEIBNIZ_REDIS_PORT=6379
      - LEIBNIZ_REDIS_DB=0
      - INTENT_SERVICE_URL=http://tara-task-intent:8002
      - RAG_SERVICE_URL=http://tara-task-rag:8003
      - STT_SERVICE_URL=http://tara-task-stt-vad:8001
      - TTS_SERVICE_URL=http://tara-task-tts-sarvam:8025
      - TARA_MODE=true
      - SKIP_INTENT_SERVICE=false
      - SKIP_APPOINTMENT_SERVICE=true
      - RESPONSE_LANGUAGE=te-mixed
      - ORGANIZATION_NAME=TASK
      - IGNORE_STT_WHILE_SPEAKING=true
      - INTRO_GREETING=నమస్కారం అండి! నేను TARA, TASK యొక్క కస్టమర్ సర్వీస్ ఏజెంట్. మీకు ఎలా సహాయం చేయగలను?
      - AUTO_START_SERVICES=true
      - DOCKER_COMPOSE_FILE=/app/docker-compose-tara-task.yml
      - DOCKER_PROJECT_NAME=tara-task
      - DOCKER_CONTEXT=desktop-linux
      - STT_GRADIO_URL=http://localhost:2012
      - TTS_GRADIO_URL=http://localhost:2005/fastrtc
      - LOG_LEVEL=INFO
      - SESSION_TTL_SECONDS=3600
      - MAX_CONCURRENT_SESSIONS=1000
      - PORT=8004
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - tara-task-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8004/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 3
    labels:
      - "com.tara.project=tara-task"
      - "com.tara.service=orchestrator"
      - "com.tara.role=master-controller"

  # ============================================================================
  # Speech-to-Text: STT-VAD Service
  # ============================================================================
  stt-vad:
    build:
      context: .
      dockerfile: stt_vad/Dockerfile
    container_name: tara-task-stt-vad
    ports:
      - "2001:8001"   # API
      - "2012:8001"   # FastRTC (mapped to API port)
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - PYTHONUNBUFFERED=1
      - STT_VAD_HOST=0.0.0.0
      - STT_VAD_PORT=8001
      - FAST_RTC_PORT=7860
      - REDIS_HOST=tara-task-redis
      - REDIS_PORT=6379
      - LEIBNIZ_REDIS_HOST=tara-task-redis
      - LEIBNIZ_REDIS_PORT=6379
      - LEIBNIZ_REDIS_DB=0
      - DOCKER_ENVIRONMENT=true
      - GEMINI_API_KEY=${GEMINI_API_KEY:-AIzaSyCJVAfzsg3KJGjry018gIoet5PVzf6azQ8}
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - tara-task-network
    restart: unless-stopped
    stdin_open: true
    tty: true
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8001/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 3
    labels:
      - "com.tara.project=tara-task"
      - "com.tara.service=stt-vad"

  # ============================================================================
  # Speech-to-Text: STT Sarvam Service (Alternative STT Provider)
  # ============================================================================
  stt-sarvam:
    build:
      context: .
      dockerfile: stt_sarvam/Dockerfile
    container_name: tara-task-stt-sarvam
    ports:
      - "2002:8001"   # API
      - "2013:8001"   # FastRTC (mapped to API port)
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - PYTHONUNBUFFERED=1
      - STT_VAD_HOST=0.0.0.0
      - STT_VAD_PORT=8001
      - FAST_RTC_PORT=7860
      - REDIS_HOST=tara-task-redis
      - REDIS_PORT=6379
      - LEIBNIZ_REDIS_HOST=tara-task-redis
      - LEIBNIZ_REDIS_PORT=6379
      - LEIBNIZ_REDIS_DB=0
      - DOCKER_ENVIRONMENT=true
      - SARVAM_API_SUBSCRIPTION_KEY=${SARVAM_API_SUBSCRIPTION_KEY:-}
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - tara-task-network
    restart: unless-stopped
    stdin_open: true
    tty: true
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8001/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 3
    labels:
      - "com.tara.project=tara-task"
      - "com.tara.service=stt-sarvam"

  # ============================================================================
  # RAG: Knowledge Base Service
  # ============================================================================
  rag:
    build:
      context: .
      dockerfile: rag/Dockerfile.tara
    container_name: tara-task-rag
    ports:
      - "2003:8003"
    volumes:
      - tara_task_rag_index:/app/index
    environment:
      - PYTHONUNBUFFERED=1
      - GEMINI_API_KEY=${GEMINI_API_KEY:-AIzaSyBPo3uwLjYxJ1ApfhqXLM2YHlefg-GTPMw}
      - GEMINI_MODEL=models/gemini-2.5-flash-lite
      - LEIBNIZ_REDIS_HOST=tara-task-redis
      - LEIBNIZ_REDIS_PORT=6379
      - LEIBNIZ_REDIS_DB=0
      - LEIBNIZ_RAG_KNOWLEDGE_BASE_PATH=/app/leibniz_knowledge_base
      - LEIBNIZ_RAG_VECTOR_STORE_PATH=/app/index
      - TARA_MODE=true
      - LEIBNIZ_RAG_RESPONSE_LANGUAGE=te-mixed
      - LEIBNIZ_RAG_ORGANIZATION=TASK
      - LEIBNIZ_RAG_AGENT_NAME=TARA
      - PORT=8003
      - LOG_LEVEL=INFO
      - ENABLE_PREWARMING=true
      - WARMUP_QUERIES_COUNT=10
      - ENABLE_MODEL_PERSISTENCE=true
      - PREPOPULATE_CACHE=true
      - GEMINI_TIMEOUT_MS=5000
      - EMBEDDING_BATCH_SIZE=32
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - tara-task-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8003/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 3
    labels:
      - "com.tara.project=tara-task"
      - "com.tara.service=rag"

  # ============================================================================
  # Text-to-Speech: TTS Sarvam Service
  # ============================================================================
  tts-sarvam:
    build:
      context: .
      dockerfile: tts_sarvam/Dockerfile
    container_name: tara-task-tts-sarvam
    ports:
      - "2005:8025"   # API + FastRTC
    environment:
      - PYTHONUNBUFFERED=1
      - SARVAM_API_KEY=${SARVAM_API_KEY:-sk_2d8w6udi_gaPItmPcCEsf3CoON7RBzqPr}
      - SARVAM_TTS_SPEAKER=anushka
      - SARVAM_TTS_LANGUAGE=te-IN
      - SARVAM_TTS_MODEL=bulbul:v2
      - TTS_STREAMING_PORT=8025
      - SARVAM_MIN_BUFFER_SIZE=10
      - SARVAM_TTS_PREPROCESSING=false
      - SARVAM_OUTPUT_AUDIO_CODEC=wav
      - LEIBNIZ_TTS_CACHE_ENABLED=true
      - LEIBNIZ_TTS_SAMPLE_RATE=22050
      - REDIS_HOST=tara-task-redis
      - REDIS_PORT=6379
      - LEIBNIZ_REDIS_HOST=tara-task-redis
      - LEIBNIZ_REDIS_PORT=6379
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - tara-task-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8025/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 3
    labels:
      - "com.tara.project=tara-task"
      - "com.tara.service=tts-sarvam"

  # ============================================================================
  # Intent Classification: Intent Service
  # ============================================================================
  intent:
    build:
      context: .
      dockerfile: intent/Dockerfile
    container_name: tara-task-intent
    ports:
      - "2007:8002"   # API
    environment:
      - PYTHONUNBUFFERED=1
      - GEMINI_API_KEY=${GEMINI_API_KEY:-AIzaSyC6cvyEl4FNjIQCV_p5_2wJkOa1cUObFHU}
      - LEIBNIZ_REDIS_HOST=tara-task-redis
      - LEIBNIZ_REDIS_PORT=6379
      - LEIBNIZ_REDIS_DB=0
      - PORT=8002
      - LOG_LEVEL=INFO
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - tara-task-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8002/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 3
    labels:
      - "com.tara.project=tara-task"
      - "com.tara.service=intent"

# ============================================================================
# Volumes
# ============================================================================
volumes:
  tara_task_redis_data:
    name: tara-task-redis-data
    labels:
      - "com.tara.project=tara-task"
  tara_task_rag_index:
    name: tara-task-rag-index
    labels:
      - "com.tara.project=tara-task"

# ============================================================================
# Network
# ============================================================================
networks:
  tara-task-network:
    name: tara-task-network
    driver: bridge
    labels:
      - "com.tara.project=tara-task"

